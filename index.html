<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Manager - Pro Plus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
        .hidden-section { display: none !important; }
        .active-nav { color: #2563eb !important; border-top: 3px solid #2563eb; }
        .active-tab { background: #2563eb !important; color: white !important; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.3s; }
        input, select, textarea { border: 1.5px solid #e2e8f0; padding: 12px; border-radius: 12px; width: 100%; outline: none; font-size: 14px; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid #eee; z-index: 1000; }
        .btn-primary { background: #2563eb; color: white; font-weight: bold; border-radius: 12px; padding: 12px; transition: 0.2s; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <div id="auth-section" class="flex items-center justify-center min-h-screen p-4">
        <div class="card p-8 w-full max-w-md border-t-8 border-blue-600">
            <h1 class="text-3xl font-black text-center text-blue-600 mb-2 tracking-tighter">MY FINANCE MANAGER</h1><br>
            <div id="email-step">
                <input type="email" id="user-email" placeholder="Gmail Address" class="mb-4">
                <input type="password" id="user-password" placeholder="Password" class="mb-4">
                <button onclick="handleLogin()" class="btn-primary w-full uppercase">Login / Register</button>
            </div>
            <div id="setup-step" class="hidden-section">
                <input type="text" id="setup-username" placeholder="Full Name" class="mb-4">
                <input type="password" id="setup-pin" placeholder="Set PIN" class="mb-4 text-center">
                <button onclick="saveProfile()" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold">START</button>
            </div>
            <div id="pin-step" class="hidden-section text-center">
                <p id="welcome-text" class="font-bold mb-4 text-lg text-blue-600 uppercase"></p>
                <input type="password" id="login-pin" placeholder="PIN" class="mb-6 text-center text-3xl tracking-widest border-b-2 border-blue-600 w-1/2 mx-auto outline-none">
                <button onclick="verifyAccess()" class="btn-primary w-full uppercase">Unlock</button>
                <button onclick="fullLogout()" class="mt-4 text-[10px] text-red-500 font-bold uppercase underline block mx-auto">Logout Account ID</button>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden-section pb-28">
        <header class="bg-white border-b p-4 sticky top-0 flex justify-between items-center z-50 shadow-sm">
            <div>
                <span class="font-black text-blue-600 uppercase">DASHBOARD</span>
                <p id="top-user-name" class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter leading-none"></p>
            </div>
            <button onclick="showSection('category-section')" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">Categories</button>
        </header>

        <div id="home-section" class="p-4 space-y-4">
            <div class="card p-6 bg-gradient-to-br from-blue-600 to-indigo-800 text-white shadow-xl">
                <p class="text-[10px] opacity-70 font-bold uppercase tracking-widest">Net Balance</p>
                <p id="net-balance" class="text-4xl font-black mt-2">৳0</p>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="card p-4 border-l-4 border-green-500"><p class="text-[9px] text-gray-400 font-bold uppercase">Income</p><p id="sum-inc" class="text-lg font-black text-green-600">৳0</p></div>
                <div class="card p-4 border-l-4 border-red-500"><p class="text-[9px] text-gray-400 font-bold uppercase">Expense</p><p id="sum-exp" class="text-lg font-black text-red-600">৳0</p></div>
                <div class="card p-4 border-l-4 border-teal-500"><p class="text-[9px] text-gray-400 font-bold uppercase">Receivable</p><p id="sum-loan-given" class="text-lg font-black text-teal-600">৳0</p></div>
                <div class="card p-4 border-l-4 border-orange-500"><p class="text-[9px] text-gray-400 font-bold uppercase">Payable</p><p id="sum-loan-taken" class="text-lg font-black text-orange-500">৳0</p></div>
            </div>

            <div class="card p-4 bg-white border-2 border-blue-50">
                <div class="flex gap-2">
                    <input type="text" id="loan-search" placeholder="Search Loan ID (LN-XXXX)" class="!p-2 text-sm">
                    <button onclick="searchLoan()" class="bg-blue-600 text-white px-4 rounded-xl"><i class="fas fa-search"></i></button>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-2">
                <button onclick="openEntry('income')" class="card p-3 text-center text-green-600"><i class="fas fa-plus-circle text-xl mb-1"></i><p class="text-[9px] font-bold">INCOME</p></button>
                <button onclick="openEntry('expense')" class="card p-3 text-center text-red-600"><i class="fas fa-minus-circle text-xl mb-1"></i><p class="text-[9px] font-bold">EXPENSE</p></button>
                <button onclick="openEntry('loan')" class="card p-3 text-center text-orange-600"><i class="fas fa-handshake text-xl mb-1"></i><p class="text-[9px] font-bold">LOAN</p></button>
                <button onclick="openRemModal()" class="card p-3 text-center text-blue-600"><i class="fas fa-bell text-xl mb-1"></i><p class="text-[9px] font-bold">BILL</p></button>
            </div>

            <h3 class="font-black text-xs text-slate-400 uppercase pt-4">Bills to Pay</h3>
            <div id="dash-rem-list" class="space-y-2"></div>
        </div>

        <div id="history-section" class="p-4 hidden-section space-y-4">
            <h2 class="text-xl font-black">History</h2>
            <div id="history-list" class="space-y-2"></div>
        </div>

        <div id="reminder-section" class="p-4 hidden-section space-y-4">
            <h2 class="text-xl font-black">All Bill Reminders</h2>
            <div id="full-rem-list" class="space-y-3"></div>
        </div>

        <div id="category-section" class="p-4 hidden-section space-y-4">
            <h2 class="text-xl font-black">Manage Categories</h2>
            <div id="category-list" class="space-y-2"></div>
        </div>

        <div class="text-center py-6">
            <p class="text-[10px] font-black text-slate-500 tracking-[5px] uppercase">MADE BY MD. SALMAN</p>
        </div>

        <nav class="nav-bar shadow-2xl">
            <button onclick="showSection('home-section')" id="nav-home" class="active-nav px-4 flex flex-col items-center"><i class="fas fa-home text-lg"></i><span class="text-[8px] mt-1">HOME</span></button>
            <button onclick="showSection('history-section')" id="nav-history" class="px-4 flex flex-col items-center"><i class="fas fa-history text-lg"></i><span class="text-[8px] mt-1">HISTORY</span></button>
            <button onclick="exitSoftware()" class="px-4 text-orange-500 flex flex-col items-center"><i class="fas fa-lock text-lg"></i><span class="text-[8px] mt-1">EXIT APP</span></button>
            <button onclick="fullLogout()" class="px-4 text-red-600 flex flex-col items-center"><i class="fas fa-power-off text-lg"></i><span class="text-[8px] mt-1">LOGOUT ID</span></button>
        </nav>
    </div>

    <script type="module">
        // [Firebase Imports and Config same as your code]
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, query, orderBy, where, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDC6k-LlYquK8qv_qoG_HuBpgTSLd_Geo8", authDomain: "finance-manager-46f3b.firebaseapp.com", projectId: "finance-manager-46f3b", storageBucket: "finance-manager-46f3b.firebasestorage.app", messagingSenderId: "155610396831", appId: "1:155610396831:web:76633015fd7a28ea7b0aaa" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        // All your other functions (saveEntry, refreshData etc.) keep them here
        // ... (Apnar original code er baki logic gula eikhane thakbe)

        // UPDATED AUTH LOGIC TO PREVENT REFRESH LOGOUT
        onAuthStateChanged(auth, async user => {
            if(user) {
                const s = await getDoc(doc(db, "users", user.uid));
                if(s.exists()){ 
                    document.getElementById('top-user-name').innerText = s.data().username; 
                    document.getElementById('welcome-text').innerText = "Hi, " + s.data().username;
                    document.getElementById('email-step').classList.add('hidden-section'); 
                    
                    // Check if already unlocked in this session
                    if(sessionStorage.getItem("app_unlocked") === "true") {
                        document.getElementById('auth-section').classList.add('hidden-section');
                        document.getElementById('main-app').classList.remove('hidden-section');
                        refreshData();
                    } else {
                        document.getElementById('pin-step').classList.remove('hidden-section'); 
                    }
                } else { 
                    document.getElementById('email-step').classList.add('hidden-section'); 
                    document.getElementById('setup-step').classList.remove('hidden-section'); 
                }
            } else {
                document.getElementById('auth-section').classList.remove('hidden-section');
                document.getElementById('email-step').classList.remove('hidden-section');
                document.getElementById('main-app').classList.add('hidden-section');
                sessionStorage.removeItem("app_unlocked");
            }
        });

        window.verifyAccess = async () => {
            const p = document.getElementById('login-pin').value;
            const s = await getDoc(doc(db, "users", auth.currentUser.uid));
            if(s.data().pin === p) { 
                sessionStorage.setItem("app_unlocked", "true"); // Save unlock state
                document.getElementById('auth-section').classList.add('hidden-section'); 
                document.getElementById('main-app').classList.remove('hidden-section'); 
                refreshData(); 
            } else alert("Wrong PIN!");
        };

        // BUTTON 1: EXIT SOFTWARE (Just Lock)
        window.exitSoftware = () => {
            sessionStorage.removeItem("app_unlocked");
            location.reload(); // PIN screen e niye jabe
        };

        // BUTTON 2: LOGOUT FROM ID
        window.fullLogout = () => {
            if(confirm("Are you sure you want to logout from this ID?")) {
                sessionStorage.removeItem("app_unlocked");
                signOut(auth).then(() => {
                    location.reload();
                });
            }
        };

        // [Add all your other remaining functions here to make the app work]
        // Example: window.refreshData, window.saveEntry, etc.
    </script>
</body>
</html>
